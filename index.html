<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Editor de Mapas Inmobiliarios</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: #f8f9fa;
            padding: 10px;
            z-index: 1100;
            display: flex;
            gap: 5px;
            box-sizing: border-box;
            height: 60px;
            align-items: center;
        }
        #map-container {
            margin-top: 60px;
            margin-bottom: 60px;
            margin-left: 20px;
            margin-right: 20px;
            width: calc(100% - 40px);
            height: calc(100vh - 120px);
            position: relative;
        }
        #map {
            height: 100%;
            width: 100%;
            z-index: 1000;
        }
        .info-form { padding: 10px; }
        .search-bar input {
            padding: 5px;
            font-family: Arial, sans-serif;
        }
        .custom-button {
            padding: 8px 15px;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-family: Arial, sans-serif;
            font-size: 14px;
            transition: background-color 0.3s ease;
            margin-right: 10px;
        }
        .custom-button:hover {
            opacity: 0.9;
        }
        #searchBtn {
            background-color: #007bff;
        }
        #locateBtn {
            background-color: #28a745;
        }
        #addPropertyBtn {
            background-color: #FF0000; /* Botón rojo */
            color: #FFFFFF; /* Letras blancas */
        }
        #exportBtn {
            background-color: #ff9800;
        }
        .import-container {
            background-color: #8b5a2b;
            border-radius: 5px;
            display: inline-flex;
            align-items: center;
            padding: 0 5px;
            vertical-align: middle;
        }
        #importBtn {
            background-color: #8b5a2b;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px 0 0 5px;
            cursor: pointer;
            font-family: Arial, sans-serif;
            font-size: 14px;
            margin: 0;
        }
        #importBtn:hover {
            opacity: 0.9;
        }
        #importInput {
            margin: 0;
            padding: 0;
            border: none;
            font-family: Arial, sans-serif;
            cursor: pointer;
            border-radius: 0 5px 5px 0;
        }
        #importInput::-webkit-file-upload-button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 0 5px 5px 0;
            cursor: pointer;
            font-family: Arial, sans-serif;
            font-size: 14px;
            margin-left: -5px;
        }
        #importInput::-webkit-file-upload-button:hover {
            opacity: 0.9;
        }
        .layer-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1100;
        }
        .layer-toggle button {
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 5px;
        }
        .layer-toggle .layer-menu {
            display: none;
            position: absolute;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            min-width: 150px;
        }
        .layer-toggle:hover .layer-menu {
            display: block;
        }
        .layer-menu a {
            display: block;
            color: white;
            text-decoration: none;
            padding: 5px 10px;
            font-family: Arial, sans-serif;
        }
        .layer-menu a:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        .image-preview {
            display: flex;
            gap: 10px;
            padding: 5px 0;
        }
        .image-preview img {
            margin: 5px;
            max-width: 300px;
            height: 225px;
            object-fit: cover;
            border: 2px solid #ccc;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
            cursor: pointer;
        }
        .image-preview .remove-img {
            position: absolute;
            top: -5px;
            right: -5px;
            background: red;
            color: white;
            border-radius: 50%;
            width: 15px;
            height: 15px;
            text-align: center;
            line-height: 15px;
            cursor: pointer;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1200;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
            font-family: Arial, sans-serif;
        }
        .modal-content img {
            max-width: 100%;
            max-height: 80vh;
        }
        .modal-buttons {
            margin-top: 10px;
        }
        .modal-buttons button {
            padding: 5px 10px;
            margin: 0 5px;
            font-family: Arial, sans-serif;
        }
        .leaflet-popup-content-wrapper {
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.8);
            max-width: 500px;
        }
        .leaflet-popup-content {
            margin: 10px;
            font-size: 14px;
            font-family: Arial, sans-serif;
        }
        .popup-table {
            width: 100%;
            border-collapse: collapse;
        }
        .popup-table td {
            padding: 5px;
        }
    </style>
</head>
<body>
    <header>
        <div class="map-controls">
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="Buscar lugar...">
                <button id="searchBtn" class="custom-button">BUSCAR</button>
                <button class="locate-btn custom-button" id="locateBtn">Localizame</button>
                <button id="addPropertyBtn" class="custom-button">Añadir inmueble</button>
                <button id="exportBtn" class="custom-button">Guardar GeoJSON</button>
                <div class="import-container">
                    <button id="importBtn" class="custom-button">Importar GeoJSON</button>
                    <input type="file" id="importInput" accept=".geojson,.json">
                </div>
            </div>
        </div>
    </header>
    <div id="map-container">
        <div id="map"></div>
        <div class="layer-toggle">
            <button><i class="fas fa-layer-group"></i></button>
            <div class="layer-menu">
                <a href="#" onclick="cambiarMapaBase('osm'); return false;">OpenStreetMap</a>
                <a href="#" onclick="cambiarMapaBase('esri'); return false;">Esri Satellite</a>
            </div>
        </div>
    </div>
    <div id="imageModal" class="modal">
        <div class="modal-content">
            <img id="modalImage">
            <div class="modal-buttons">
                <button id="prevBtn" class="custom-button">Anterior</button>
                <button id="nextBtn" class="custom-button">Siguiente</button>
                <button id="closeModalBtn" class="custom-button">Cerrar</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" onload="console.log('Leaflet cargado')" onerror="console.error('Error al cargar Leaflet')"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js" onload="console.log('Leaflet Draw cargado')" onerror="console.error('Error al cargar Leaflet Draw')"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" onload="console.log('JSZip cargado')" onerror="console.error('Error al cargar JSZip')"></script>

    <script>
        if (typeof L === 'undefined') {
            console.error('Leaflet no está definido. Asegúrate de que la biblioteca se cargó correctamente.');
        } else {
            console.log('Leaflet está definido. Procediendo a inicializar el mapa.');

            const map = L.map('map').setView([-32.0589, -59.2276], 8);
            console.log('Mapa inicializado:', map);

            const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
            const esriSatellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: ' Esri'
            });

            let currentBaseLayer = osmLayer;

            function cambiarMapaBase(type) {
                map.eachLayer(function(layer) {
                    if (layer instanceof L.TileLayer) {
                        map.removeLayer(layer);
                    }
                });
                if (type === 'osm') {
                    currentBaseLayer = osmLayer;
                } else if (type === 'esri') {
                    currentBaseLayer = esriSatellite;
                }
                currentBaseLayer.addTo(map);
                console.log(`Cambiando a ${type}, zoom actual: ${map.getZoom()}, centro: (${map.getCenter().lat}, ${map.getCenter().lng})`);
            }

            const drawnItems = new L.FeatureGroup();
            map.addLayer(drawnItems);

            const drawControl = new L.Control.Draw({
                edit: { featureGroup: drawnItems },
                draw: {
                    marker: true,
                    polygon: false,
                    polyline: false,
                    rectangle: false,
                    circle: false,
                    circlemarker: false
                }
            });
            map.addControl(drawControl);

            function getMarkerStyle(type, category) {
                let color;
                switch (type) {
                    case 'baldio':
                        color = '#00FF00';
                        break;
                    case 'departamento':
                        color = '#FF0000';
                        break;
                    case 'vivienda':
                        color = '#00BFFF';
                        break;
                    default:
                        color = 'black';
                }
                const fillOpacity = category === 'venta' ? 0.8 : 0;
                const weight = category === 'alquiler' ? 3 : 1;
                return {
                    radius: 8,
                    fillColor: color,
                    color: color,
                    weight: weight,
                    opacity: 1,
                    fillOpacity: fillOpacity
                };
            }

            async function getAddressFromCoords(lat, lng) {
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`);
                    const data = await response.json();
                    if (data && data.address) {
                        const address = data.address.road ? `${data.address.road}, ${data.address.house_number || ''}` : 'Dirección no detectada';
                        const locality = data.address.city || data.address.town || data.address.village || 'Localidad no detectada';
                        return { address, locality };
                    }
                    return { address: 'Dirección no detectada', locality: 'Localidad no detectada' };
                } catch (error) {
                    console.error('Error al obtener dirección:', error);
                    return { address: 'Dirección no detectada', locality: 'Localidad no detectada' };
                }
            }

            document.getElementById('searchBtn').addEventListener('click', function() {
                const query = document.getElementById('searchInput').value;
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.length > 0) {
                            const lat = parseFloat(data[0].lat);
                            const lon = parseFloat(data[0].lon);
                            map.setView([lat, lon], 13);
                        } else {
                            alert('Lugar no encontrado');
                        }
                    });
            });

            document.getElementById('locateBtn').addEventListener('click', function() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function(position) {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        map.setView([lat, lon], 13);
                        L.marker([lat, lon]).addTo(map).bindPopup('Estás aquí').openPopup();
                    }, function() {
                        alert('No se pudo obtener tu ubicación.');
                    });
                } else {
                    alert('Geolocalización no soportada por este navegador.');
                }
            });

            // Modo para añadir inmueble manualmente
            let isAddingProperty = false;
            document.getElementById('addPropertyBtn').addEventListener('click', function() {
                if (isAddingProperty) {
                    // Desactivar modo
                    isAddingProperty = false;
                    map.off('click', addPropertyOnClick);
                    document.getElementById('addPropertyBtn').textContent = 'Añadir inmueble';
                    map.getContainer().style.cursor = '';
                } else {
                    // Activar modo
                    isAddingProperty = true;
                    document.getElementById('addPropertyBtn').textContent = 'Cancelar';
                    map.getContainer().style.cursor = 'crosshair';
                    map.on('click', addPropertyOnClick);
                }
            });

            function addPropertyOnClick(e) {
                const latlng = e.latlng;
                getAddressFromCoords(latlng.lat, latlng.lng).then(({ address, locality }) => {
                    const circleMarker = L.circleMarker(latlng, getMarkerStyle('vivienda', 'venta'));
                    circleMarker.properties = { imagenes: [], address: address, locality: locality, tipo: 'vivienda', category: 'venta' };
                    drawnItems.addLayer(circleMarker);
                    mostrarFormulario(circleMarker);
                    // Desactivar el modo después de añadir
                    isAddingProperty = false;
                    map.off('click', addPropertyOnClick);
                    document.getElementById('addPropertyBtn').textContent = 'Añadir inmueble';
                    map.getContainer().style.cursor = '';
                });
            }

            document.getElementById('exportBtn').addEventListener('click', async function() {
                const geojson = {
                    type: "FeatureCollection",
                    features: []
                };

                drawnItems.eachLayer(function(layer) {
                    if (layer instanceof L.CircleMarker) {
                        const latlng = layer.getLatLng();
                        const properties = layer.properties || {};
                        const feature = {
                            type: "Feature",
                            geometry: {
                                type: "Point",
                                coordinates: [latlng.lng, latlng.lat]
                            },
                            properties: properties
                        };
                        geojson.features.push(feature);
                    }
                });

                const dataStr = JSON.stringify(geojson, null, 2);

                if (window.showSaveFilePicker) {
                    try {
                        const handle = await window.showSaveFilePicker({
                            suggestedName: 'inmuebles.geojson',
                            types: [{
                                description: 'GeoJSON Files',
                                accept: { 'application/json': ['.geojson', '.json'] }
                            }],
                        });
                        const writable = await handle.createWritable();
                        await writable.write(dataStr);
                        await writable.close();
                        console.log('Archivo guardado en:', handle.name);
                    } catch (err) {
                        if (err.name !== 'AbortError') {
                            console.error('Error al guardar el archivo:', err);
                            alert('No se pudo guardar el archivo. Verifica los permisos o intenta de nuevo.');
                        }
                    }
                } else {
                    alert('Tu navegador no soporta la selección de directorio. Se descargará el archivo automáticamente. Usa un navegador moderno (como Chrome 86+) para una mejor experiencia.');
                    const blob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const downloadAnchorNode = document.createElement('a');
                    downloadAnchorNode.setAttribute("href", url);
                    downloadAnchorNode.setAttribute("download", "inmuebles.geojson");
                    document.body.appendChild(downloadAnchorNode);
                    downloadAnchorNode.click();
                    document.body.removeChild(downloadAnchorNode);
                    URL.revokeObjectURL(url);
                }
            });

            document.getElementById('importBtn').addEventListener('click', function() {
                document.getElementById('importInput').click();
            });

            document.getElementById('importInput').addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    console.log('Contenido leído:', e.target.result);
                    try {
                        const geojson = JSON.parse(e.target.result);
                        if (geojson.type !== "FeatureCollection") {
                            alert("El archivo no es un GeoJSON válido.");
                            return;
                        }

                        const action = drawnItems.getLayers().length > 0 ? confirm('¿Quieres reemplazar los puntos existentes o agregar los nuevos? (Cancelar para agregar)') : false;
                        if (action) {
                            drawnItems.clearLayers();
                        }

                        L.geoJSON(geojson, {
                            pointToLayer: function(feature, latlng) {
                                const circleMarker = L.circleMarker(latlng, getMarkerStyle(feature.properties.tipo || 'vivienda', feature.properties.category || 'venta'));
                                circleMarker.properties = feature.properties;
                                return circleMarker;
                            },
                            onEachFeature: function(feature, layer) {
                                drawnItems.addLayer(layer);
                                layer.bindPopup(generarPrevisualizacion(layer));
                            }
                        });
                    } catch (error) {
                        console.error('Error al cargar el archivo GeoJSON:', error);
                        console.log('Contenido problemático:', e.target.result);
                        alert('Error al cargar el archivo. Asegúrate de que sea un GeoJSON válido. Revisa la consola para más detalles.');
                    }
                };
                reader.readAsText(file);
            });

            map.on(L.Draw.Event.CREATED, function(e) {
                const marker = e.layer;
                const latlng = marker.getLatLng();
                getAddressFromCoords(latlng.lat, latlng.lng).then(({ address, locality }) => {
                    const circleMarker = L.circleMarker(latlng, getMarkerStyle('vivienda', 'venta'));
                    circleMarker.properties = { imagenes: [], address: address, locality: locality, tipo: 'vivienda', category: 'venta' };
                    drawnItems.addLayer(circleMarker);
                    mostrarFormulario(circleMarker);
                });
            });

            map.on(L.Draw.Event.EDITED, function(e) {
                e.layers.eachLayer(function(layer) {
                    if (layer instanceof L.CircleMarker && layer.properties) {
                        layer.setStyle(getMarkerStyle(layer.properties.tipo, layer.properties.category));
                        mostrarFormulario(layer);
                    }
                });
            });

            function mostrarFormulario(layer) {
                const props = layer.properties || {};
                const latlng = layer.getLatLng();
                console.log('Mostrando formulario para layer:', layer);
                getAddressFromCoords(latlng.lat, latlng.lng).then(({ address, locality }) => {
                    const popupContent = `
                        <div class="info-form">
                            <h3>Datos del Inmueble</h3>
                            <label>Dirección: <input type="text" id="address" value="${props.address || address}"></label><br>
                            <label>Localidad: <input type="text" id="locality" value="${props.locality || locality}" readonly></label><br>
                            <label>Superficie Terreno (m²): <input type="number" id="supTerreno" value="${props.supTerreno || ''}"></label><br>
                            <label>Superficie Cubierta (m²): <input type="number" id="supCubierta" value="${props.supCubierta || ''}"></label><br>
                            <label>Superficie Semicubierta (m²): <input type="number" id="supSemi" value="${props.supSemi || ''}"></label><br>
                            <label>Tipo: 
                                <select id="tipo" onchange="actualizarEstilo('${layer._leaflet_id}')">
                                    <option value="baldio" ${props.tipo === 'baldio' ? 'selected' : ''}>Baldío</option>
                                    <option value="departamento" ${props.tipo === 'departamento' ? 'selected' : ''}>Departamento</option>
                                    <option value="vivienda" ${props.tipo === 'vivienda' ? 'selected' : ''}>Vivienda</option>
                                </select>
                            </label><br>
                            <label>Categoría: 
                                <select id="category" onchange="actualizarEstilo('${layer._leaflet_id}')">
                                    <option value="venta" ${props.category === 'venta' ? 'selected' : ''}>Venta</option>
                                    <option value="alquiler" ${props.category === 'alquiler' ? 'selected' : ''}>Alquiler</option>
                                </select>
                            </label><br>
                            <label>Precio (USD): <input type="number" id="precio" value="${props.precio || ''}"></label><br>
                            <label>Imágenes (máx 3, 800x600px): <input type="file" id="imagenes" accept="image/jpeg,image/png" multiple></label><br>
                            <div id="imagePreview"></div>
                            <button onclick="guardarDatos('${layer._leaflet_id}')">Guardar</button>
                            <button onclick="editarDatos('${layer._leaflet_id}')">Editar</button>
                            <button onclick="eliminarPunto('${layer._leaflet_id}')">Eliminar</button>
                        </div>
                    `;
                    layer.bindPopup(popupContent).openPopup();
                    if (props.imagenes && props.imagenes.length > 0) mostrarPrevisualizacionImagenes(props.imagenes);
                    if (props.tipo && props.category) {
                        layer.setStyle(getMarkerStyle(props.tipo, props.category));
                    }
                }).catch(error => console.error('Error en getAddressFromCoords:', error));
            }

            function actualizarEstilo(layerId) {
                const layer = drawnItems.getLayer(layerId);
                if (layer && layer instanceof L.CircleMarker) {
                    const tipo = document.getElementById('tipo').value;
                    const category = document.getElementById('category').value;
                    layer.properties = layer.properties || {};
                    layer.properties.tipo = tipo;
                    layer.properties.category = category;
                    layer.setStyle(getMarkerStyle(tipo, category));
                }
            }

            function guardarDatos(layerId) {
                const layer = drawnItems.getLayer(layerId);
                if (!layer || !(layer instanceof L.CircleMarker)) {
                    console.error('Layer no encontrado o no es un CircleMarker:', layerId);
                    return;
                }

                const address = document.getElementById('address').value;
                const locality = document.getElementById('locality').value;
                const supTerreno = document.getElementById('supTerreno').value;
                const supCubierta = document.getElementById('supCubierta').value;
                const supSemi = document.getElementById('supSemi').value;
                const tipo = document.getElementById('tipo').value;
                const category = document.getElementById('category').value;
                const precio = document.getElementById('precio').value;
                const imagenesInput = document.getElementById('imagenes').files;

                layer.properties = layer.properties || { imagenes: [] };
                if (!Array.isArray(layer.properties.imagenes)) layer.properties.imagenes = [];

                if (imagenesInput.length + layer.properties.imagenes.length > 3) {
                    alert('Máximo 3 imágenes por punto.');
                    return;
                }

                layer.properties.address = address;
                layer.properties.locality = locality;
                layer.properties.supTerreno = supTerreno;
                layer.properties.supCubierta = supCubierta;
                layer.properties.supSemi = supSemi;
                layer.properties.tipo = tipo;
                layer.properties.category = category;
                layer.properties.precio = precio;

                if (imagenesInput.length > 0) {
                    procesarImagenes(imagenesInput, layer);
                } else {
                    actualizarPrevisualizacion(layer);
                }
                layer.setStyle(getMarkerStyle(tipo, category));
            }

            function procesarImagenes(files, layer) {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                let processed = 0;

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    if (!file.type.match('image/jpeg|image/png')) {
                        alert('Solo se permiten JPG o PNG.');
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = new Image();
                        img.onload = function() {
                            const maxWidth = 800;
                            let width = img.width;
                            let height = img.height;
                            if (width > maxWidth) {
                                height = (maxWidth / width) * height;
                                width = maxWidth;
                            }
                            canvas.width = width;
                            canvas.height = height;
                            ctx.drawImage(img, 0, 0, width, height);
                            layer.properties.imagenes.push(canvas.toDataURL('image/jpeg'));
                            processed++;
                            if (processed === files.length) actualizarPrevisualizacion(layer);
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            }

            function mostrarPrevisualizacionImagenes(imagenes) {
                const preview = document.getElementById('imagePreview');
                if (preview) {
                    preview.innerHTML = imagenes.map((img, index) => `
                        <div class="image-preview">
                            <img src="${img}" onclick="openImageModal(${index}, ${JSON.stringify(imagenes)})">
                            <span class="remove-img" onclick="eliminarImagen('${img}', ${index})">X</span>
                        </div>
                    `).join('');
                }
            }

            function eliminarImagen(imgSrc, index) {
                const layer = drawnItems.getLayers().find(l => l.properties?.imagenes?.includes(imgSrc));
                if (layer) {
                    layer.properties.imagenes.splice(index, 1);
                    mostrarFormulario(layer);
                }
            }

            function eliminarPunto(layerId) {
                const layer = drawnItems.getLayer(layerId);
                if (layer) {
                    drawnItems.removeLayer(layer);
                }
            }

            function actualizarPrevisualizacion(layer) {
                if (layer instanceof L.CircleMarker) {
                    layer.setStyle(getMarkerStyle(layer.properties.tipo, layer.properties.category));
                    layer.setPopupContent(generarPrevisualizacion(layer));
                    layer.closePopup();
                    layer.openPopup();
                }
            }

            function editarDatos(layerId) {
                const layer = drawnItems.getLayer(layerId);
                if (layer && layer instanceof L.CircleMarker) mostrarFormulario(layer);
            }

            function generarPrevisualizacion(layer) {
                const props = layer.properties || {};
                return `
                    <table class="popup-table">
                        <tr><th colspan="2"><h3>Datos del Inmueble</h3></th></tr>
                        <tr><td>Dirección:</td><td>${props.address || 'No especificada'}</td></tr>
                        <tr><td>Localidad:</td><td>${props.locality || 'No detectada'}</td></tr>
                        <tr><td>Terreno:</td><td>${props.supTerreno || ''} m²</td></tr>
                        <tr><td>Cubierta:</td><td>${props.supCubierta || ''} m²</td></tr>
                        <tr><td>Semicubierta:</td><td>${props.supSemi || ''} m²</td></tr>
                        <tr><td>Tipo:</td><td>${props.tipo || ''}</td></tr>
                        <tr><td>Categoría:</td><td>${props.category || ''}</td></tr>
                        <tr><td>Precio:</td><td>$${props.precio || ''} USD</td></tr>
                        <tr><td>Imágenes:</td><td><div class="image-preview">${props.imagenes && props.imagenes.length > 0 ? props.imagenes.map((img, index) => `<img src="${img}" onclick="openImageModal(${index}, ${JSON.stringify(props.imagenes)})">`).join('') : 'Ninguna'}</div></td></tr>
                        <tr><td colspan="2"><button onclick="editarDatos('${layer._leaflet_id}')">Editar</button></td></tr>
                        <tr><td colspan="2"><button onclick="eliminarPunto('${layer._leaflet_id}')">Eliminar</button></td></tr>
                    </table>
                `;
            }

            let currentImageIndex = 0;
            let modalImages = [];

            function openImageModal(index, images) {
                modalImages = images;
                currentImageIndex = index;
                document.getElementById('modalImage').src = modalImages[currentImageIndex];
                document.getElementById('imageModal').style.display = 'flex';
                updateModalButtons();
            }

            function closeModal() {
                document.getElementById('imageModal').style.display = 'none';
            }

            function prevImage() {
                currentImageIndex = (currentImageIndex - 1 + modalImages.length) % modalImages.length;
                document.getElementById('modalImage').src = modalImages[currentImageIndex];
                updateModalButtons();
            }

            function nextImage() {
                currentImageIndex = (currentImageIndex + 1) % modalImages.length;
                document.getElementById('modalImage').src = modalImages[currentImageIndex];
                updateModalButtons();
            }

            function updateModalButtons() {
                document.getElementById('prevBtn').disabled = modalImages.length <= 1;
                document.getElementById('nextBtn').disabled = modalImages.length <= 1;
            }

            document.getElementById('closeModalBtn').addEventListener('click', closeModal);
            document.getElementById('prevBtn').addEventListener('click', prevImage);
            document.getElementById('nextBtn').addEventListener('click', nextImage);
            document.getElementById('imageModal').addEventListener('click', function(e) {
                if (e.target === this) closeModal();
            });
        }
    </script>
</body>
</html>